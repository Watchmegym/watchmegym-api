generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// MODELO: USUÁRIOS
// ==========================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  active    Boolean  @default(true)
  cpfCnpj   String?  @unique
  phone     String?
  asaasCustomerId String? @unique
  bioimpedancias Bioimpedance[] @relation("UserBioimpedance")
  academyUsers AcademyUser[] @relation("UserAcademy")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  statisticsCameraUsers StatisticsCameraUserExercise[] @relation("StatisticsCameraUserExercise")
  records Record[] @relation("RecordUser")
  subscriptions Subscription[] @relation("UserSubscription")
  payments Payment[] @relation("UserPayment")

  @@map("usuarios")
}

// ==========================================
// MODELO: BIOIMPEDANCIAS
// ==========================================
model Bioimpedance {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation("UserBioimpedance", fields: [userId], references: [id], onDelete: Restrict) 
  weight    Float
  height    Float
  bmi       Float
  bmr       Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bioimpedancias")
}

// ==========================================
// MODELO: ACADEMIAS
// ==========================================

model Academy {
  id        String   @id @default(uuid())
  name      String
  address   String
  phone     String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  academyUsers AcademyUser[] @relation("AcademyUser")
  cameras Camera[] @relation("AcademyCamera")

  @@map("academias")
}

// ==========================================
// MODELO: ACADEMIAS X USUÁRIOS
// ==========================================

model AcademyUser {
  id        String   @id @default(uuid())
  academyId String
  academy   Academy @relation("AcademyUser", fields: [academyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("UserAcademy", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("academia_usuarios")
}

// ==========================================
// MODELO: CAMERAS
// ==========================================

model Camera {
  id        String   @id @default(uuid())
  academyId String
  academy   Academy @relation("AcademyCamera", fields: [academyId], references: [id], onDelete: Restrict) 
  exerciseId String?
  exercise   Exercise? @relation("ExerciseCamera", fields: [exerciseId], references: [id], onDelete: SetNull)
  name      String
  description String
  url       String
  streamUrl String
  enabled     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  statisticsCameraUsers StatisticsCameraUserExercise[] @relation("StatisticsCameraUserExercise")
  records Record[] @relation("RecordCamera")
  @@map("cameras")
}

// ==========================================
// MODELO: Exercícios
// ==========================================

model Exercise {
  id        String   @id @default(uuid())
  name      String
  description String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cameras Camera[] @relation("ExerciseCamera")

  @@map("exercicios")
}

// ==========================================
// MODELO: Estatísticas X Câmeras X Usuários
// ==========================================

model StatisticsCameraUserExercise {
  id        String   @id @default(uuid())
  cameraId String
  camera   Camera @relation("StatisticsCameraUserExercise", fields: [cameraId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("StatisticsCameraUserExercise", fields: [userId], references: [id], onDelete: Cascade)
  quantityRepetitions Int
  quantitySets Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("estatisticas_usuarios_cameras")
}

// ==========================================
// MODELO: Gravações
// ==========================================

model Record {
  id        String   @id @default(uuid())
  cameraId String
  camera   Camera @relation("RecordCamera", fields: [cameraId], references: [id], onDelete: Restrict)
  userId    String
  user      User     @relation("RecordUser", fields: [userId], references: [id], onDelete: Restrict)
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gravacoes")
}

// ==========================================
// MODELO: PLANOS DE ASSINATURA
// ==========================================

model Plan {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  price       Float
  billingType String   @default("CREDIT_CARD") // CREDIT_CARD, BOLETO, PIX
  cycle       String   @default("MONTHLY") // MONTHLY, QUARTERLY, YEARLY
  features    Json?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subscriptions Subscription[] @relation("PlanSubscription")

  @@map("planos")
}

// ==========================================
// MODELO: ASSINATURAS
// ==========================================

model Subscription {
  id                  String    @id @default(uuid())
  userId              String
  user                User      @relation("UserSubscription", fields: [userId], references: [id], onDelete: Restrict)
  planId              String
  plan                Plan      @relation("PlanSubscription", fields: [planId], references: [id], onDelete: Restrict)
  asaasSubscriptionId String?   @unique
  asaasCustomerId     String?
  status              String    @default("ACTIVE") // ACTIVE, EXPIRED, CANCELED, SUSPENDED
  startDate           DateTime  @default(now())
  endDate             DateTime?
  nextDueDate         DateTime?
  paymentMethod       String?   // CREDIT_CARD, BOLETO, PIX
  autoRenew           Boolean   @default(true)
  canceledAt          DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  payments Payment[] @relation("SubscriptionPayment")

  @@map("assinaturas")
}

// ==========================================
// MODELO: PAGAMENTOS/FATURAS
// ==========================================

model Payment {
  id              String       @id @default(uuid())
  subscriptionId  String?
  subscription    Subscription? @relation("SubscriptionPayment", fields: [subscriptionId], references: [id], onDelete: SetNull)
  userId          String
  user            User         @relation("UserPayment", fields: [userId], references: [id], onDelete: Restrict)
  asaasPaymentId  String?      @unique
  amount          Float
  status          String       @default("PENDING") // PENDING, RECEIVED, CONFIRMED, OVERDUE, REFUNDED, CANCELED
  billingType     String       // CREDIT_CARD, BOLETO, PIX
  dueDate         DateTime
  paymentDate     DateTime?
  invoiceUrl      String?
  pixQrCode       String?
  bankSlipUrl     String?
  description     String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("pagamentos")
}