generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// MODELO: USUÁRIOS
// ==========================================
// Autenticação gerenciada pelo Supabase Auth
// Tabela local armazena apenas dados de perfil
model User {
  id              String   @id @default(uuid())
  supabaseAuthId  String?  @unique  // ID do usuário no auth.users do Supabase
  email           String   @unique
  name            String
  active          Boolean  @default(true)
  cpfCnpj         String?  @unique
  phone           String?
  profilePictureUrl String?
  asaasCustomerId String?  @unique
  bioimpedancias  Bioimpedance[] @relation("UserBioimpedance")
  academyUsers    AcademyUser[] @relation("UserAcademy")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  statisticsCameraUsers StatisticsCameraUserExercise[] @relation("StatisticsCameraUserExercise")
  records         Record[] @relation("RecordUser")
  subscriptions   Subscription[] @relation("UserSubscription")
  payments        Payment[] @relation("UserPayment")
  userScanFaceVideos UserScanFaceVideo[] @relation("UserScanFaceUserVideo")
  @@map("usuarios")
}

// ==========================================
// MODELO: BIOIMPEDANCIAS
// ==========================================
model Bioimpedance {
  id        String   @id @default(uuid())
  userId    String?
  user      User?     @relation("UserBioimpedance", fields: [userId], references: [id], onDelete: Restrict) 
  
  // === INFORMAÇÕES DO DISPOSITIVO ===
  deviceModel     String?   // Modelo do dispositivo (ex: X18_5)
  unitName        String?   // Nome da unidade
  unitNo          String?   // Número da unidade
  macAddr         String?   // Endereço MAC do dispositivo
  deviceNo        String?   // Número do dispositivo
  
  // === INFORMAÇÕES DO USUÁRIO (da máquina) ===
  machineUserId   String?   // ID do usuário na máquina
  name            String?   // Nome do usuário na máquina
  loginType       String?   // Tipo de login (0, 1, etc)
  measureTime     DateTime? // Horário da medição (chave para upsert)
  address         String?   // Endereço
  birthday        DateTime? // Data de nascimento
  age             Int?      // Idade
  sex             Int?      // Sexo (1 = masculino, 2 = feminino)
  recordNo        String?   // Número do registro
  
  // === DADOS BÁSICOS ===
  weight          Float?     // Peso (kg)
  height          Float?     // Altura (cm ou m)
  bmi             Float?     // IMC calculado
  bmiType         String?   // Tipo de IMC
  bmiStatus       Int?      // Status do IMC (0=baixo, 1=normal, 2=alto)
  bmiRange        String?   // Faixa normal do IMC (ex: "18.5-24.9")
  weightStatus    Int?      // Status do peso
  weightRange     String?   // Faixa normal do peso (ex: "56.7 - 76.5")
  
  // === ÁGUA CORPORAL ===
  waterECW        Float?    // Água extracelular (kg)
  waterECWRange   String?   // Faixa normal
  waterECWStatus  Int?      // Status
  waterICW        Float?    // Água intracelular (kg)
  waterICWRange   String?   // Faixa normal
  waterICWStatus  Int?      // Status
  waterRate       Float?    // Taxa de água corporal (%)
  waterRateRange  String?   // Faixa normal
  waterRateStatus Int?      // Status
  
  // === PROTEÍNA ===
  protein         Float?    // Proteína (kg)
  proteinRange    String?   // Faixa normal
  proteinStatus   Int?      // Status
  
  // === OSSOS ===
  bone            Float?    // Massa óssea (kg)
  boneRange       String?   // Faixa normal
  boneStatus      Int?      // Status
  
  // === CORPO GERAL ===
  bodyShape       String?   // Forma corporal (ex: "Bem torneado")
  bodyScore       Int?      // Pontuação corporal (0-100)
  bodyAge         Int?      // Idade corporal
  
  // === MASSA MAGRA ===
  fatFree         Float?    // Massa livre de gordura (kg)
  fatFreeRange    String?   // Faixa normal
  fatFreeStatus   Int?      // Status
  
  // === GORDURA GERAL ===
  fat             Float?    // Gordura total (kg)
  fatRate         Float?    // Taxa de gordura (%)
  fatRateRange    String?   // Faixa normal
  fatRateStatus   Int?      // Status
  
  // === GORDURA POR REGIÃO ===
  fatLeftLeg      Float?    // Gordura perna esquerda (kg)
  fatRightLeg     Float?    // Gordura perna direita (kg)
  fatLeftArm      Float?    // Gordura braço esquerdo (kg)
  fatRightArm     Float?    // Gordura braço direito (kg)
  fatTrunk        Float?    // Gordura tronco (kg)
  
  // === MASSA MUSCULAR ===
  muscleRate      Float?    // Taxa muscular (%)
  muscleRateRange String?   // Faixa normal
  muscleRateStatus Int?     // Status
  muscleLeftLeg   Float?    // Músculo perna esquerda (kg)
  muscleRightLeg  Float?    // Músculo perna direita (kg)
  muscleLeftArm   Float?    // Músculo braço esquerdo (kg)
  muscleRightArm  Float?    // Músculo braço direito (kg)
  muscleTrunk     Float?    // Músculo tronco (kg)
  skeletalMuscle  Float?    // Músculo esquelético (kg)
  
  // === MINERAIS ===
  mineral         Float?    // Minerais (kg)
  mineralRange    String?   // Faixa normal
  mineralStatus   Int?      // Status
  
  // === METABOLISMO ===
  bmr             Float     // Taxa metabólica basal (kcal)
  bmrRange        String?   // Faixa normal
  bmrStatus       Int?      // Status
  dci             Int?      // Ingestão calórica diária recomendada (kcal)
  
  // === GORDURA VISCERAL ===
  visceralFat       Int?    // Nível de gordura visceral (1-59)
  visceralFatRange  String? // Faixa normal (ex: "1.0 - 9.0")
  visceralFatStatus Int?    // Status
  
  // === GORDURA SUBCUTÂNEA ===
  fatSubcutaneousRate   Float?  // Taxa de gordura subcutânea (%)
  fatSubcutaneousRange  String? // Faixa normal
  fatSubcutaneousStatus Int?    // Status
  
  // === AJUSTES RECOMENDADOS ===
  weightAdjustment Float?   // Ajuste de peso recomendado (kg)
  muscleAdjustment Float?   // Ajuste de músculo recomendado (kg)
  fatAdjustment    Float?   // Ajuste de gordura recomendado (kg)
  
  // === ATIVIDADES RECOMENDADAS (minutos) ===
  swimMinutes     Int?      // Minutos de natação
  walkingMinutes  Int?      // Minutos de caminhada
  joggingMinutes  Int?      // Minutos de corrida
  aerobicMinutes  Int?      // Minutos de aeróbico
  
  // === TIMESTAMPS ===
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Índice para busca por measureTime (upsert)
  @@index([userId, measureTime])
  @@map("bioimpedancias")
}

// ==========================================
// MODELO: ACADEMIAS
// ==========================================

model Academy {
  id        String   @id @default(uuid())
  name      String
  address   String
  phone     String
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  academyUsers AcademyUser[] @relation("AcademyUser")
  cameras Camera[] @relation("AcademyCamera")

  @@map("academias")
}

// ==========================================
// MODELO: ACADEMIAS X USUÁRIOS
// ==========================================

model AcademyUser {
  id        String   @id @default(uuid())
  academyId String
  academy   Academy @relation("AcademyUser", fields: [academyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("UserAcademy", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("academia_usuarios")
}

// ==========================================
// MODELO: CAMERAS
// ==========================================

model Camera {
  id        String   @id @default(uuid())
  academyId String
  academy   Academy @relation("AcademyCamera", fields: [academyId], references: [id], onDelete: Restrict) 
  exerciseId String?
  exercise   Exercise? @relation("ExerciseCamera", fields: [exerciseId], references: [id], onDelete: SetNull)
  name      String
  description String
  url       String
  streamUrl String
  enabled     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  statisticsCameraUsers StatisticsCameraUserExercise[] @relation("StatisticsCameraUserExercise")
  records Record[] @relation("RecordCamera")
  @@map("cameras")
}

// ==========================================
// MODELO: Exercícios
// ==========================================

model Exercise {
  id        String   @id @default(uuid())
  name      String
  description String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cameras Camera[] @relation("ExerciseCamera")
  ExerciseVideo ExerciseVideo[] @relation("ExerciseVideo")    
  trainings TrainingExercise[] @relation("TrainingExercise")    
  @@map("exercicios")
}

model ExerciseVideo {
  id        String   @id @default(uuid())
  exerciseId String
  exercise   Exercise @relation("ExerciseVideo", fields: [exerciseId], references: [id], onDelete: Restrict)
  url String
  thumbnailUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("videos_exercicios")
}

// ==========================================
// MODELO: Treinos
// ==========================================

model Training {
  id        String   @id @default(uuid())
  name String
  description String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  exercises TrainingExercise[] @relation("TrainingExercise")  
  @@map("treinos")
}

model TrainingExercise {
  id        String   @id @default(uuid())
  trainingId String
  training   Training @relation("TrainingExercise", fields: [trainingId], references: [id], onDelete: Restrict)
  exerciseId String
  exercise   Exercise @relation("TrainingExercise", fields: [exerciseId], references: [id], onDelete: Restrict)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("exercicios_treinos")
}

// ==========================================
// MODELO: Estatísticas X Câmeras X Usuários
// ==========================================

model StatisticsCameraUserExercise {
  id        String   @id @default(uuid())
  cameraId String
  camera   Camera @relation("StatisticsCameraUserExercise", fields: [cameraId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("StatisticsCameraUserExercise", fields: [userId], references: [id], onDelete: Cascade)
  quantityRepetitions Int
  quantitySets Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("estatisticas_usuarios_cameras")
}





// ==========================================
// MODELO: Gravações
// ==========================================

model Record {
  id        String   @id @default(uuid())
  cameraId String
  camera   Camera @relation("RecordCamera", fields: [cameraId], references: [id], onDelete: Restrict)
  userId    String
  user      User     @relation("RecordUser", fields: [userId], references: [id], onDelete: Restrict)
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gravacoes")
}

// ==========================================
// MODELO: PLANOS DE ASSINATURA
// ==========================================

model Plan {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  price       Float
  billingType String   @default("CREDIT_CARD") // CREDIT_CARD, BOLETO, PIX
  cycle       String   @default("MONTHLY") // MONTHLY, QUARTERLY, YEARLY
  features    Json?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subscriptions Subscription[] @relation("PlanSubscription")

  @@map("planos")
}

// ==========================================
// MODELO: ASSINATURAS
// ==========================================

model Subscription {
  id                  String    @id @default(uuid())
  userId              String
  user                User      @relation("UserSubscription", fields: [userId], references: [id], onDelete: Restrict)
  planId              String
  plan                Plan      @relation("PlanSubscription", fields: [planId], references: [id], onDelete: Restrict)
  asaasSubscriptionId String?   @unique
  asaasCustomerId     String?
  status              String    @default("ACTIVE") // ACTIVE, EXPIRED, CANCELED, SUSPENDED
  startDate           DateTime  @default(now())
  endDate             DateTime?
  nextDueDate         DateTime?
  paymentMethod       String?   // CREDIT_CARD, BOLETO, PIX
  autoRenew           Boolean   @default(true)
  canceledAt          DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  payments Payment[] @relation("SubscriptionPayment")

  @@map("assinaturas")
}

// ==========================================
// MODELO: PAGAMENTOS/FATURAS
// ==========================================

model Payment {
  id              String       @id @default(uuid())
  subscriptionId  String?
  subscription    Subscription? @relation("SubscriptionPayment", fields: [subscriptionId], references: [id], onDelete: SetNull)
  userId          String
  user            User         @relation("UserPayment", fields: [userId], references: [id], onDelete: Restrict)
  asaasPaymentId  String?      @unique
  amount          Float
  status          String       @default("PENDING") // PENDING, RECEIVED, CONFIRMED, OVERDUE, REFUNDED, CANCELED
  billingType     String       // CREDIT_CARD, BOLETO, PIX
  dueDate         DateTime
  paymentDate     DateTime?
  invoiceUrl      String?
  pixQrCode       String?
  bankSlipUrl     String?
  description     String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("pagamentos")
}

// ==========================================
// MODELO: SCAN FACE USER VIDEO
// ==========================================

model UserScanFaceVideo {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation("UserScanFaceUserVideo", fields: [userId], references: [id])
  videoUrl  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("usuarios_scan_face_videos")
}